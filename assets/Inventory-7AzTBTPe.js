import{r as a,l as H,m as K,j as e,P as _,F as f,B as y,s as R,f as B,h as w,t as ee,C as te,n as ae,o as se,b as ne,T as re,v as le,w as A,x as ie,y as oe,z as J,e as ue,u as ce,D as de,E as be}from"./index-FFqeMi9I.js";import{S as me}from"./SupplierSelect-DTx7JHT8.js";function L({isOpen:N,setIsOpen:i,row:t}){const[h,c]=a.useState(!1),[j,g]=a.useState(""),[x,C]=a.useState(""),[l,m]=a.useState(""),[p,k]=a.useState("0"),[O,P]=a.useState(0),[v,s]=a.useState(0),[o,u]=a.useState(0),[d,M]=a.useState(""),[b,D]=a.useState("cash"),[r,I]=a.useState("0"),[Q,E]=a.useState(""),[U,V]=a.useState({}),$=H();a.useEffect(()=>{var n;t&&(g(t.name||""),C(t.category||""),m(t.unit||""),k(((n=t.quantity)==null?void 0:n.toString())||"0"),P(t.minQuantity||0),s(t.costPerUnit||0),u(t.sellPerUnit||0),E(t.notes||""))},[t]),a.useEffect(()=>{N||(g(""),C(""),m(""),k("0"),P(0),s(0),u(0),M(""),I("0"),E(""),D("cash"),V({}))},[N]);const F=K({mutationFn:n=>R(n),onSuccess:()=>{alert("✅ تم شراء المنتج وتسجيل العملية بنجاح!"),i(!1),$.invalidateQueries({queryKey:["products-table"]})},onError:n=>{console.error(n),alert("❌ حدث خطأ أثناء معالجة العملية")}}),G=n=>{n.preventDefault();const S={};if(j||(S.name="⚠️ الرجاء إدخال اسم المنتج"),x||(S.category="⚠️ الرجاء إدخال الصنف"),l||(S.unit="⚠️ الرجاء إدخال الوحدة"),Number(p)<=0&&(S.quantity="⚠️ الكمية يجب أن تكون أكبر من صفر"),v<=0&&(S.costPerUnit="⚠️ سعر الشراء يجب أن يكون أكبر من صفر"),o<=0&&(S.sellPerUnit="⚠️ سعر البيع يجب أن يكون أكبر من صفر"),d||(S.supplierId="⚠️ الرجاء اختيار المورد"),b==="part"){Number(r)<=0&&(S.partValue="⚠️ الدفعة الجزئية يجب أن تكون أكبر من صفر");const Z=Number(p)*v;Number(r)>=Z&&(S.partValue="⚠️ الدفعة الجزئية يجب أن تكون أقل من المجموع الكلي")}if(V(S),Object.keys(S).length>0)return;const q=Number(p)*v;let T=0,z="unpaid";b==="cash"?(T=q,z="paid"):b==="part"&&(T=Number(r),z="partial");const W={name:j,category:x,unit:l,quantity:Number(p),minQuantity:O,costPerUnit:v,sellPerUnit:o,lastUpdated:new Date().toISOString()},X={type:"in",quantity:Number(p),reason:"شراء من المورد",createdAt:new Date().toISOString()},Y={type:"purchase",relatedId:d,items:[{quantity:Number(p),cost:v}],subTotal:q,discount:0,total:q,paidAmount:T,remainingAmount:q-T,status:z,paymentMethod:b==="cash"?"cash":b==="part"?"part":"debt",dueDate:new Date().toISOString(),notes:Q,createdBy:"system"};F.mutate({supplierId:d,itemData:W,logData:X,invoiceData:Y})};return e.jsx(_,{title:"شراء منتج من مورد",isOpen:N,setIsOpen:i,trigger:e.jsx(y,{children:"شراء منتج"}),children:e.jsxs("form",{dir:"rtl",onSubmit:G,className:"grid grid-cols-2 gap-3",children:[e.jsx(f,{id:"productName",label:"اسم المنتج",value:j,onChange:n=>g(n.target.value),error:U.name}),e.jsx(f,{id:"productCategory",label:"الصنف",value:x,onChange:n=>C(n.target.value),error:U.category}),e.jsx(f,{id:"unit",label:"الوحدة",value:l,onChange:n=>m(n.target.value),error:U.unit}),e.jsx(f,{id:"quantity",label:"الكمية",type:"number",value:p,onChange:n=>k(n.target.value),error:U.quantity}),e.jsx(f,{id:"costPerUnit",label:"سعر الشراء للواحدة",type:"number",value:v,onChange:n=>s(Number(n.target.value)),error:U.costPerUnit}),e.jsx(f,{id:"sellPerUnit",label:"سعر البيع للواحدة",type:"number",value:o,onChange:n=>u(Number(n.target.value)),error:U.sellPerUnit}),e.jsx(f,{id:"invMinQuantity",label:"الحد الأدنى للكمية",type:"number",value:O,onChange:n=>P(Number(n.target.value))}),e.jsx(me,{className:"col-span-2",isOpen:h,setIsOpen:c,supplierId:d,setSupplierId:M,withDataTable:!0}),e.jsxs("div",{className:"col-span-2 grid grid-cols-3 gap-2",children:[e.jsx(y,{onClick:()=>D("cash"),variant:b==="cash"?"default":"outline",type:"button",children:"نقدًا"}),e.jsx(y,{onClick:()=>D("part"),variant:b==="part"?"default":"outline",type:"button",children:"جزئي"}),e.jsx(y,{onClick:()=>D("debt"),variant:b==="debt"?"default":"outline",type:"button",children:"دين"})]}),b==="part"&&e.jsx(f,{id:"partPayment",label:"قيمة الدفعة الجزئية",type:"number",value:r,onChange:n=>I(n.target.value),error:U.partValue}),e.jsx(f,{id:"notes",label:"ملاحظات",value:Q,onChange:n=>E(n.target.value)}),e.jsx(y,{className:"col-span-2 mt-3",type:"submit",variant:"default",disabled:F.isPending,children:F.isPending?"جاري التحميل ...":"تأكيد العملية"})]})})}function pe({isOpen:N,setIsOpen:i,selectedItems:t,createdBy:h}){const[c,j]=a.useState("cash"),[g,x]=a.useState(""),[C,l]=a.useState(!1),[m,p]=a.useState(""),[k,O]=a.useState(""),[P,v]=a.useState(0),s=H(),o=a.useMemo(()=>t.reduce((r,I)=>r+I.costPerUnit*I.needQty,0),[t]),u=Math.max(o-P,0),d=a.useMemo(()=>c==="cash"?u:c==="part"&&Number(g)||0,[c,g,u]),M=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"needQty",label:"الكمية المستخدمة",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"cost",label:"السعر النهائي",sortable:!0}],b=K({mutationFn:r=>ee(r),onSuccess:()=>{alert("تم اتمام عملية البيع بنجاح"),s.invalidateQueries({queryKey:["inventory-items"]}),i(!1)},onError:r=>{console.error(r),alert((r==null?void 0:r.message)||"حدث خطأ أثناء عملية البيع")}}),D=r=>{if(r.preventDefault(),t.length===0){alert("يرجى اختيار العناصر للبيع");return}if(c==="part"&&(!g||Number(g)<=0)){alert("يرجى إدخال قيمة الدفعة الجزئية الصحيحة");return}const I={customerId:m||void 0,createdBy:h,invoiceData:{items:t.map(Q=>({itemId:Q.id,quantity:Q.needQty,cost:Q.costPerUnit})),subTotal:o,discount:P,total:u,paidAmount:d,paymentMethod:c==="debt"?"debt":"cash",notes:k||""}};b.mutate(I)};return e.jsxs("div",{children:[e.jsx(B,{titleButton:e.jsx(y,{variant:"outline",className:"w-1/4 mr-auto",onClick:()=>i(!1),children:"رجوع"}),searchable:!1,defaultPageSize:3,title:`المجموع: ${o}`,pageSizeOptions:[3],data:t?t.map(r=>({...r,cost:r.costPerUnit*r.needQty})):[],columns:M}),e.jsxs("form",{className:"space-y-2",onSubmit:D,children:[e.jsx(f,{label:"حسم",type:"number",value:P,onChange:r=>v(Number(r.target.value))}),e.jsxs("label",{children:["المجموع النهائي: ",u]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 md:col-span-2",children:[e.jsx(y,{onClick:()=>j("cash"),className:"col-span-1",variant:c==="cash"?"default":"outline",type:"button",children:"نقدا"}),e.jsx(y,{onClick:()=>j("part"),className:"col-span-1",variant:c==="part"?"default":"outline",type:"button",children:"جزئي"}),e.jsx(y,{onClick:()=>j("debt"),className:"col-span-1",variant:c==="debt"?"default":"outline",type:"button",children:"دين"})]}),c==="part"&&e.jsx(f,{id:"partPayment",label:"قيمة الدفعة",type:"number",value:g,onChange:r=>x(r.target.value)}),e.jsx(w,{isOpen:C,setIsOpen:l,className:"",customerId:m,setCustomerId:p}),e.jsx(f,{label:"ملاحظات",value:k,onChange:r=>O(r.target.value)}),e.jsx(y,{className:"w-full md:col-span-2",type:"submit",disabled:b.isPending,children:b.isPending?"جاري إتمام البيع...":"اتمام عملية البيع"})]}),b.isError&&e.jsx("p",{className:"text-red-500 mt-2",children:b.error.message})]})}function ye({setIsOpen:N,selectedItems:i}){const t=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"needQty",label:"الكمية المستخدمة",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"cost",label:"السعر النهائي",sortable:!0}];return e.jsx("div",{children:e.jsx(B,{titleButton:e.jsx(y,{variant:"outline",className:"w-1/4 mr-auto",onClick:()=>N(!1),children:"رجوع"}),searchable:!1,defaultPageSize:3,title:"المجموع",pageSizeOptions:[3],data:i?i.map(h=>({...h,cost:h.costPerUnit*h.needQty})):[],columns:t})})}function he({products:N=[],selectedRows:i,setSelectedRows:t}){const[h,c]=a.useState("table"),[j,g]=a.useState(null),[x,C]=a.useState(1),[l,m]=a.useState(10);a.useEffect(()=>{const s=JSON.parse(localStorage.getItem("InventoryUser")||"null");g(s)},[]);const p=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"unit",label:"الواحدة",sortable:!0},{key:"needQty",label:"الكمية المستخدمة",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"category",label:"الصنف",sortable:!0}],k=(s,o)=>{t(u=>u.map(d=>d.id===s?{...d,needQty:o}:d))},O=s=>{t(o=>o.some(d=>d.id===s.id)?o.filter(d=>d.id!==s.id):[...o,s])},P=(s,o)=>{const u=s[o];return o==="needQty"?e.jsx("input",{type:"number",value:u||"",onChange:d=>k(s.id,Number(d.target.value)),className:"w-full border rounded px-1 text-right"}):u},v=a.useMemo(()=>{const s=(x-1)*l;return i.slice(s,s+l)},[i,x,l]);return h==="sell"?j?e.jsx(pe,{createdBy:j.username,selectedItems:i,isOpen:!0,setIsOpen:()=>c("table")}):e.jsx("p",{children:"Loading user..."}):h==="create"?e.jsx(ye,{setIsOpen:()=>c("table"),selectedItems:i}):e.jsxs(te,{children:[e.jsxs(ae,{children:[e.jsx(se,{children:"انشاء منتج / بيع مواد"}),e.jsx("div",{className:"flex gap-4 pt-4",children:e.jsx(y,{variant:"accent",className:"w-full",onClick:()=>c("sell"),children:"بيع المواد"})})]}),e.jsxs(ne,{children:[e.jsxs(re,{children:[e.jsx(le,{children:e.jsx(A,{children:p.map(s=>e.jsx(ie,{className:s.hidden?"hidden":"text-center",children:s.label},s.key))})}),e.jsx(oe,{children:v.length>0?v.map((s,o)=>e.jsx(A,{onDoubleClick:()=>O(s),className:"cursor-pointer hover:bg-muted/50",children:p.map(u=>e.jsx(J,{className:u.hidden?"hidden":"",children:P(s,u.key)},u.key))},o)):e.jsx(A,{children:e.jsx(J,{colSpan:p.length,className:"text-center",children:"لا توجد بيانات"})})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("span",{children:["الصفحة ",x," من"," ",Math.ceil(i.length/l)||1]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{size:"sm",variant:"outline",onClick:()=>C(s=>Math.max(s-1,1)),disabled:x===1,children:"السابق"}),e.jsx(y,{size:"sm",variant:"outline",onClick:()=>C(s=>Math.min(s+1,Math.ceil(i.length/l))),disabled:x>=Math.ceil(i.length/l),children:"التالي"})]})]})]})]})}function fe(){ue();const[N,i]=a.useState(!1),[t,h]=a.useState([]),{data:c,isLoading:j}=ce({queryKey:["products-table"],queryFn:be}),g=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"unit",label:"الواحدة",sortable:!0},{key:"quantity",label:"الكمية",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"lastUpdated",label:"اخر تعديل",sortable:!0},{key:"category",label:"الصنف",sortable:!0}],x=l=>t.some(m=>JSON.stringify(m)===JSON.stringify({...l,needQty:0})),C=l=>{h(m=>x(l)?m.filter(k=>JSON.stringify(k)!==JSON.stringify({...l,needQty:0})):[...m,l])};return e.jsxs(de,{children:[e.jsx("div",{children:e.jsx(B,{title:"قائمة المنتجات",titleButton:e.jsx(L,{isOpen:N,setIsOpen:i}),columns:g,data:c||[],onRowClick:l=>C(l),getRowClassName:l=>t!=null&&t.some(m=>m==l)?"bg-green-50 hover:bg-green-100":"",renderRowActions:l=>e.jsx("div",{className:"flex gap-1",children:e.jsx(L,{isOpen:N,setIsOpen:i,row:l})})})}),(t==null?void 0:t.length)>0?e.jsx(he,{selectedRows:t,setSelectedRows:h,products:t}):e.jsx("div",{})]})}export{fe as default};
