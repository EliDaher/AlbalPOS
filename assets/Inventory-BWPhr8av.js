import{r,l as B,m as V,j as e,P as G,F as x,B as d,s as w,f as K,h as R,t as ee,C as te,n as ae,o as se,b as ne,T as re,v as le,w as A,x as ie,y as ue,z as H,E as oe,e as ce,u as de,D as be,G as pe}from"./index-BNCxgLps.js";import{S as me}from"./SupplierSelect-1PsYwUqS.js";function $({isOpen:S,setIsOpen:u,row:s}){const[p,o]=r.useState(!1),[j,m]=r.useState(""),[y,C]=r.useState(""),[i,b]=r.useState(""),[h,g]=r.useState("0"),[O,f]=r.useState(0),[N,U]=r.useState(0),[P,k]=r.useState(0),[I,t]=r.useState(""),[n,c]=r.useState("cash"),[a,Q]=r.useState("0"),[q,T]=r.useState(""),[D,L]=r.useState({}),J=B();r.useEffect(()=>{var l;s&&(m(s.name||""),C(s.category||""),b(s.unit||""),g(((l=s.quantity)==null?void 0:l.toString())||"0"),f(s.minQuantity||0),U(s.costPerUnit||0),k(s.sellPerUnit||0),T(s.notes||""))},[s]),r.useEffect(()=>{S||(m(""),C(""),b(""),g("0"),f(0),U(0),k(0),t(""),Q("0"),T(""),c("cash"),L({}))},[S]);const F=V({mutationFn:l=>w(l),onSuccess:()=>{alert("✅ تم شراء المنتج وتسجيل العملية بنجاح!"),u(!1),J.invalidateQueries({queryKey:["products-table"]})},onError:l=>{console.error(l),alert("❌ حدث خطأ أثناء معالجة العملية")}}),W=l=>{l.preventDefault();const v={};if(j||(v.name="⚠️ الرجاء إدخال اسم المنتج"),y||(v.category="⚠️ الرجاء إدخال الصنف"),i||(v.unit="⚠️ الرجاء إدخال الوحدة"),Number(h)<=0&&(v.quantity="⚠️ الكمية يجب أن تكون أكبر من صفر"),N<=0&&(v.costPerUnit="⚠️ سعر الشراء يجب أن يكون أكبر من صفر"),P<=0&&(v.sellPerUnit="⚠️ سعر البيع يجب أن يكون أكبر من صفر"),I||(v.supplierId="⚠️ الرجاء اختيار المورد"),n==="part"){Number(a)<=0&&(v.partValue="⚠️ الدفعة الجزئية يجب أن تكون أكبر من صفر");const _=Number(h)*N;Number(a)>=_&&(v.partValue="⚠️ الدفعة الجزئية يجب أن تكون أقل من المجموع الكلي")}if(L(v),Object.keys(v).length>0)return;const M=Number(h)*N;let E=0,z="unpaid";n==="cash"?(E=M,z="paid"):n==="part"&&(E=Number(a),z="partial");const X={name:j,category:y,unit:i,quantity:Number(h),minQuantity:O,costPerUnit:N,sellPerUnit:P,lastUpdated:new Date().toISOString()},Y={type:"in",quantity:Number(h),reason:"شراء من المورد",createdAt:new Date().toISOString()},Z={type:"purchase",relatedId:I,items:[{quantity:Number(h),cost:N}],subTotal:M,discount:0,total:M,paidAmount:E,remainingAmount:M-E,status:z,paymentMethod:n==="cash"?"cash":n==="part"?"part":"debt",dueDate:new Date().toISOString(),notes:q,createdBy:"system"};F.mutate({supplierId:I,itemData:X,logData:Y,invoiceData:Z})};return e.jsx(G,{title:"شراء منتج من مورد",isOpen:S,setIsOpen:u,trigger:e.jsx(d,{children:"شراء منتج"}),children:e.jsxs("form",{dir:"rtl",onSubmit:W,className:"grid grid-cols-2 gap-3",children:[e.jsx(x,{id:"productName",label:"اسم المنتج",value:j,onChange:l=>m(l.target.value),error:D.name}),e.jsx(x,{id:"productCategory",label:"الصنف",value:y,onChange:l=>C(l.target.value),error:D.category}),e.jsx(x,{id:"unit",label:"الوحدة",value:i,onChange:l=>b(l.target.value),error:D.unit}),e.jsx(x,{id:"quantity",label:"الكمية",type:"number",value:h,onChange:l=>g(l.target.value),error:D.quantity}),e.jsx(x,{id:"costPerUnit",label:"سعر الشراء للواحدة",type:"number",value:N,onChange:l=>U(Number(l.target.value)),error:D.costPerUnit}),e.jsx(x,{id:"sellPerUnit",label:"سعر البيع للواحدة",type:"number",value:P,onChange:l=>k(Number(l.target.value)),error:D.sellPerUnit}),e.jsx(x,{id:"invMinQuantity",label:"الحد الأدنى للكمية",type:"number",value:O,onChange:l=>f(Number(l.target.value))}),e.jsx(me,{className:"col-span-2",isOpen:p,setIsOpen:o,supplierId:I,setSupplierId:t,withDataTable:!0}),e.jsxs("div",{className:"col-span-2 grid grid-cols-3 gap-2",children:[e.jsx(d,{onClick:()=>c("cash"),variant:n==="cash"?"default":"outline",type:"button",children:"نقدًا"}),e.jsx(d,{onClick:()=>c("part"),variant:n==="part"?"default":"outline",type:"button",children:"جزئي"}),e.jsx(d,{onClick:()=>c("debt"),variant:n==="debt"?"default":"outline",type:"button",children:"دين"})]}),n==="part"&&e.jsx(x,{id:"partPayment",label:"قيمة الدفعة الجزئية",type:"number",value:a,onChange:l=>Q(l.target.value),error:D.partValue}),e.jsx(x,{id:"notes",label:"ملاحظات",value:q,onChange:l=>T(l.target.value)}),e.jsx(d,{className:"col-span-2 mt-3",type:"submit",variant:"default",disabled:F.isPending,children:F.isPending?"جاري التحميل ...":"تأكيد العملية"})]})})}function ye({isOpen:S,setIsOpen:u,selectedItems:s,createdBy:p}){const[o,j]=r.useState("cash"),[m,y]=r.useState(""),[C,i]=r.useState(!1),[b,h]=r.useState(""),[g,O]=r.useState(""),[f,N]=r.useState(0),U=B(),P=r.useMemo(()=>s.reduce((a,Q)=>a+Q.costPerUnit*Q.needQty,0),[s]),k=Math.max(P-f,0),I=r.useMemo(()=>o==="cash"?k:o==="part"&&Number(m)||0,[o,m,k]),t=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"needQty",label:"الكمية المستخدمة",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"cost",label:"السعر النهائي",sortable:!0}],n=V({mutationFn:a=>ee(a),onSuccess:()=>{alert("تم اتمام عملية البيع بنجاح"),U.invalidateQueries({queryKey:["inventory-items"]}),u(!1)},onError:a=>{console.error(a),alert((a==null?void 0:a.message)||"حدث خطأ أثناء عملية البيع")}}),c=a=>{if(a.preventDefault(),s.length===0){alert("يرجى اختيار العناصر للبيع");return}if(o==="part"&&(!m||Number(m)<=0)){alert("يرجى إدخال قيمة الدفعة الجزئية الصحيحة");return}const Q={customerId:b||void 0,createdBy:p,invoiceData:{items:s.map(q=>({itemId:q.id,quantity:q.needQty,cost:q.costPerUnit})),subTotal:P,discount:f,total:k,paidAmount:I,paymentMethod:o==="debt"?"debt":"cash",notes:g||""}};n.mutate(Q)};return e.jsxs("div",{children:[e.jsx(K,{titleButton:e.jsx(d,{variant:"outline",className:"w-1/4 mr-auto",onClick:()=>u(!1),children:"رجوع"}),searchable:!1,defaultPageSize:3,title:`المجموع: ${P}`,pageSizeOptions:[3],data:s?s.map(a=>({...a,cost:a.costPerUnit*a.needQty})):[],columns:t}),e.jsxs("form",{className:"space-y-2",onSubmit:c,children:[e.jsx(x,{label:"حسم",type:"number",value:f,onChange:a=>N(Number(a.target.value))}),e.jsxs("label",{children:["المجموع النهائي: ",k]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 md:col-span-2",children:[e.jsx(d,{onClick:()=>j("cash"),className:"col-span-1",variant:o==="cash"?"default":"outline",type:"button",children:"نقدا"}),e.jsx(d,{onClick:()=>j("part"),className:"col-span-1",variant:o==="part"?"default":"outline",type:"button",children:"جزئي"}),e.jsx(d,{onClick:()=>j("debt"),className:"col-span-1",variant:o==="debt"?"default":"outline",type:"button",children:"دين"})]}),o==="part"&&e.jsx(x,{id:"partPayment",label:"قيمة الدفعة",type:"number",value:m,onChange:a=>y(a.target.value)}),e.jsx(R,{isOpen:C,setIsOpen:i,className:"",customerId:b,setCustomerId:h}),e.jsx(x,{label:"ملاحظات",value:g,onChange:a=>O(a.target.value)}),e.jsx(d,{className:"w-full md:col-span-2",type:"submit",disabled:n.isPending,children:n.isPending?"جاري إتمام البيع...":"اتمام عملية البيع"})]}),n.isError&&e.jsx("p",{className:"text-red-500 mt-2",children:n.error.message})]})}function he({setIsOpen:S,selectedItems:u}){const s=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"needQty",label:"الكمية المستخدمة",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"cost",label:"السعر النهائي",sortable:!0}];return e.jsx("div",{children:e.jsx(K,{titleButton:e.jsx(d,{variant:"outline",className:"w-1/4 mr-auto",onClick:()=>S(!1),children:"رجوع"}),searchable:!1,defaultPageSize:3,title:"المجموع",pageSizeOptions:[3],data:u?u.map(p=>({...p,cost:p.costPerUnit*p.needQty})):[],columns:s})})}function ge({products:S=[],selectedRows:u,setSelectedRows:s}){const[p,o]=r.useState("table"),[j,m]=r.useState(null),[y,C]=r.useState(1),[i,b]=r.useState(10),[h,g]=r.useState(!1),O=B();r.useEffect(()=>{const t=JSON.parse(localStorage.getItem("InventoryUser")||"null");m(t)},[]);const f=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"unit",label:"الواحدة",sortable:!0},{key:"needQty",label:"الكمية المستخدمة",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"category",label:"الصنف",sortable:!0}],N=V({mutationFn:t=>oe(t),onSuccess:()=>{alert("تم انقاص الكميات من المخزون بنجاح."),s([]),O.invalidateQueries({queryKey:["products-table"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء انقاص الكميات من المخزون.")}}),U=(t,n)=>{s(c=>c.map(a=>a.id===t?{...a,needQty:n}:a))},P=t=>{s(n=>n.some(a=>a.id===t.id)?n.filter(a=>a.id!==t.id):[...n,t])},k=(t,n)=>{const c=t[n];return n==="needQty"?e.jsx("input",{type:"number",value:c||"",onChange:a=>U(t.id,Number(a.target.value)),className:"w-full border rounded px-1 text-right"}):c},I=r.useMemo(()=>{const t=(y-1)*i;return u.slice(t,t+i)},[u,y,i]);return p==="sell"?j?e.jsx(ye,{createdBy:j.username,selectedItems:u,isOpen:!0,setIsOpen:()=>o("table")}):e.jsx("p",{children:"Loading user..."}):p==="create"?e.jsx(he,{setIsOpen:()=>o("table"),selectedItems:u}):e.jsxs(te,{children:[e.jsxs(ae,{children:[e.jsx(se,{children:"انشاء منتج / بيع مواد"}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx(d,{variant:"accent",className:"w-full",onClick:()=>o("sell"),children:"بيع المواد"}),e.jsxs(G,{isOpen:h,setIsOpen:g,title:"",trigger:e.jsx(d,{onClick:t=>{t.stopPropagation(),u.map(n=>{if(!n.needQty||n.needQty<=0)throw alert(`الرجاء تحديد كمية صحيحة للمنتج: ${n.name}`),new Error("Invalid quantity");g(!0)})},className:"w-full",children:"انقاص من المخزون"}),children:[e.jsxs("div",{children:[u.map(t=>e.jsx("div",{className:"flex justify-between mb-2",children:e.jsxs("span",{children:[t.needQty," ",t.unit," من ",t.name]})},t.id)),"هل انت متأكد من انك تريد انقاص الكميات المحددة من المخزون؟"]}),e.jsx(d,{onClick:()=>{let t=[];u.map(n=>t.push({id:n.id,quantity:n.needQty})),N.mutate(t),g(!1)},children:"تأكيد وانقاص من المخزون"})]})]})]}),e.jsxs(ne,{children:[e.jsxs(re,{children:[e.jsx(le,{children:e.jsx(A,{children:f.map(t=>e.jsx(ie,{className:t.hidden?"hidden":"text-center",children:t.label},t.key))})}),e.jsx(ue,{children:I.length>0?I.map((t,n)=>e.jsx(A,{onDoubleClick:()=>P(t),className:"cursor-pointer hover:bg-muted/50",children:f.map(c=>e.jsx(H,{className:c.hidden?"hidden":"",children:k(t,c.key)},c.key))},n)):e.jsx(A,{children:e.jsx(H,{colSpan:f.length,className:"text-center",children:"لا توجد بيانات"})})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("span",{children:["الصفحة ",y," من"," ",Math.ceil(u.length/i)||1]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{size:"sm",variant:"outline",onClick:()=>C(t=>Math.max(t-1,1)),disabled:y===1,children:"السابق"}),e.jsx(d,{size:"sm",variant:"outline",onClick:()=>C(t=>Math.min(t+1,Math.ceil(u.length/i))),disabled:y>=Math.ceil(u.length/i),children:"التالي"})]})]})]})]})}function fe(){ce();const[S,u]=r.useState(!1),[s,p]=r.useState([]),{data:o,isLoading:j}=de({queryKey:["products-table"],queryFn:pe}),m=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"unit",label:"الواحدة",sortable:!0},{key:"quantity",label:"الكمية",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"lastUpdated",label:"اخر تعديل",sortable:!0},{key:"category",label:"الصنف",sortable:!0}],y=i=>s.some(b=>b.id===i.id),C=i=>{p(b=>y(i)?b.filter(g=>g.id!==i.id):[...b,i])};return e.jsxs(be,{children:[e.jsx("div",{children:e.jsx(K,{title:"قائمة المنتجات",titleButton:e.jsx($,{isOpen:S,setIsOpen:u}),columns:m,data:o||[],onRowClick:i=>C(i),getRowClassName:i=>s!=null&&s.some(b=>b==i)?"bg-green-50 hover:bg-green-100":"",renderRowActions:i=>e.jsx("div",{className:"flex gap-1",children:e.jsx($,{isOpen:S,setIsOpen:u,row:i})})})}),(s==null?void 0:s.length)>0?e.jsx("div",{children:e.jsx(ge,{selectedRows:s,setSelectedRows:p,products:s})}):e.jsx("div",{})]})}export{fe as default};
