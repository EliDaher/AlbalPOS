import{r as s,u as A,b as B,j as e,P as L,F as k,B as d,x as X,n as P,c as V,o as Y,y as Z,C as _,s as w,t as R,k as ee,T as te,z as ae,E as z,G as se,J as ne,K,M as re,m as le,a as ie,D as oe,e as ue}from"./index-Bo_gVS4x.js";import{S as ce}from"./SupplierSelect-DrKCXhz2.js";function de({isOpen:y,setIsOpen:i,row:n}){const[h,c]=s.useState(!1),[g,x]=s.useState(""),[v,N]=s.useState(""),[b,I]=s.useState(""),[l,u]=s.useState(""),[S,f]=s.useState(""),[Q,D]=s.useState(""),[C,U]=s.useState(""),[m,t]=s.useState("cash"),[r,p]=s.useState(""),[a,q]=s.useState({}),O=A();s.useEffect(()=>{n&&y&&(x(n.name||""),N(n.category||""),I(n.unit||""),f(n.costPerUnit||0),D(n.sellPerUnit||0))},[n,y]),s.useEffect(()=>{y||(x(""),N(""),I(""),u("0"),f("0"),D("0"),U(""),p("0"),t("cash"),q({}))},[y]);const T=B({mutationFn:o=>X(o),onSuccess:()=>{P.success(" تم شراء المنتج وتسجيل العملية بنجاح!"),i(!1),O.invalidateQueries({queryKey:["items-table"]})},onError:o=>{console.error(o),P.error("حدث خطأ أثناء معالجة العملية")}}),H=o=>{o.preventDefault();const j={};if(g||(j.name="⚠️ الرجاء إدخال اسم المنتج"),v||(j.category="⚠️ الرجاء إدخال الصنف"),b||(j.unit="⚠️ الرجاء إدخال الوحدة"),Number(l)<=0&&(j.quantity="⚠️ الكمية يجب أن تكون أكبر من صفر"),Number(S)<=0&&(j.costPerUnit="⚠️ سعر الشراء يجب أن يكون أكبر من صفر"),Number(Q)<=0&&(j.sellPerUnit="⚠️ سعر البيع يجب أن يكون أكبر من صفر"),C||(j.supplierId="⚠️ الرجاء اختيار المورد"),m==="part"){Number(r)<=0&&(j.partValue="⚠️ الدفعة الجزئية يجب أن تكون أكبر من صفر");const W=Number(l)*Number(S);Number(r)>=W&&(j.partValue="⚠️ الدفعة الجزئية يجب أن تكون أقل من المجموع الكلي")}if(q(j),Object.keys(j).length>0&&P.error(JSON.stringify(j)),Object.keys(j).length>0)return;const M=Number(l)*Number(S);let E=0,F="unpaid";m==="cash"?(E=M,F="paid"):m==="part"&&(E=Number(r),F="partial");const J={name:g,category:v,unit:b,minQuantity:0,quantity:Number(l),costPerUnit:Number(S),sellPerUnit:Number(Q),lastUpdated:new Date().toISOString()},$={type:"in",quantity:Number(l),reason:"شراء من المورد",createdAt:new Date().toISOString()},G={type:"purchase",relatedId:C,items:[{quantity:Number(l),cost:Number(S)}],subTotal:M,discount:0,total:M,paidAmount:E,remainingAmount:M-E,status:F,paymentMethod:m==="cash"?"cash":m==="part"?"part":"debt",dueDate:new Date().toISOString(),createdBy:"system",notes:""};T.mutate({supplierId:C,itemData:J,logData:$,invoiceData:G})};return e.jsx(L,{title:"شراء منتج من مورد",isOpen:y,setIsOpen:i,trigger:e.jsx(d,{children:"شراء منتج"}),children:e.jsxs("form",{dir:"rtl",className:"grid grid-cols-2 gap-3",children:[e.jsx(k,{id:"productName",label:"اسم المنتج",value:g,onChange:o=>x(o.target.value),error:a.name}),e.jsx(k,{id:"productCategory",label:"الصنف",value:v,onChange:o=>N(o.target.value),error:a.category}),e.jsx(k,{id:"unit",label:"الوحدة",value:b,onChange:o=>I(o.target.value),error:a.unit}),e.jsx(k,{id:"quantity",label:"الكمية",type:"number",value:l,onChange:o=>u(o.target.value),error:a.quantity}),e.jsx(k,{id:"costPerUnit",label:"سعر الشراء للواحدة",type:"number",value:S,onChange:o=>f(o.target.value),error:a.costPerUnit}),e.jsx(k,{id:"sellPerUnit",label:"سعر البيع للواحدة",type:"number",value:Q,onChange:o=>D(o.target.value),error:a.sellPerUnit}),e.jsx(ce,{className:"col-span-2",isOpen:h,setIsOpen:c,supplierId:C,setSupplierId:U,withDataTable:!0}),e.jsxs("div",{className:"col-span-2 grid grid-cols-3 gap-2",children:[e.jsx(d,{onClick:()=>t("cash"),variant:m==="cash"?"default":"outline",type:"button",children:"نقدًا"}),e.jsx(d,{onClick:()=>t("part"),variant:m==="part"?"default":"outline",type:"button",children:"جزئي"}),e.jsx(d,{onClick:()=>t("debt"),variant:m==="debt"?"default":"outline",type:"button",children:"دين"})]}),m==="part"&&e.jsx(k,{id:"partPayment",label:"قيمة الدفعة الجزئية",type:"number",value:r,onChange:o=>p(o.target.value),error:a.partValue}),e.jsx(d,{className:"col-span-2 mt-3",onClick:o=>{H(o)},variant:"default",disabled:T.isPending,children:T.isPending?"جاري التحميل ...":"تأكيد العملية"})]})})}function be({isOpen:y,setIsOpen:i,selectedItems:n,createdBy:h}){const[c,g]=s.useState("cash"),[x,v]=s.useState(""),[N,b]=s.useState(!1),[I,l]=s.useState(""),[u,S]=s.useState(""),[f,Q]=s.useState(0),D=A(),C=s.useMemo(()=>n.reduce((a,q)=>a+q.costPerUnit*q.needQty,0),[n]),U=Math.max(C-f,0),m=s.useMemo(()=>c==="cash"?U:c==="part"&&Number(x)||0,[c,x,U]),t=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"needQty",label:"الكمية المستخدمة",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"cost",label:"السعر النهائي",sortable:!0}],r=B({mutationFn:a=>Z(a),onSuccess:()=>{P.success("تم اتمام عملية البيع بنجاح"),D.invalidateQueries({queryKey:["inventory-items"]}),i(!1)},onError:a=>{console.error(a),P.error((a==null?void 0:a.message)||"حدث خطأ أثناء عملية البيع")}}),p=a=>{if(a.preventDefault(),n.length===0){P.error("يرجى اختيار العناصر للبيع");return}if(c==="part"&&(!x||Number(x)<=0)){P.error("يرجى إدخال قيمة الدفعة الجزئية الصحيحة");return}const q={customerId:I||void 0,createdBy:h,invoiceData:{items:n.map(O=>({itemId:O.id,quantity:O.needQty,cost:O.costPerUnit})),subTotal:C,discount:f,total:U,paidAmount:m,paymentMethod:c==="debt"?"debt":"cash",notes:u||""}};r.mutate(q)};return e.jsxs("div",{children:[e.jsx(V,{titleButton:e.jsx(d,{variant:"outline",className:"w-1/4 mr-auto",onClick:()=>i(!1),children:"رجوع"}),searchable:!1,defaultPageSize:3,title:`المجموع: ${C}`,pageSizeOptions:[3],data:n?n.map(a=>({...a,cost:a.costPerUnit*a.needQty})):[],columns:t}),e.jsxs("form",{className:"space-y-2",onSubmit:p,children:[e.jsx(k,{label:"حسم",type:"number",value:f,onChange:a=>Q(Number(a.target.value))}),e.jsxs("label",{children:["المجموع النهائي: ",U]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 md:col-span-2",children:[e.jsx(d,{onClick:()=>g("cash"),className:"col-span-1",variant:c==="cash"?"default":"outline",type:"button",children:"نقدا"}),e.jsx(d,{onClick:()=>g("part"),className:"col-span-1",variant:c==="part"?"default":"outline",type:"button",children:"جزئي"}),e.jsx(d,{onClick:()=>g("debt"),className:"col-span-1",variant:c==="debt"?"default":"outline",type:"button",children:"دين"})]}),c==="part"&&e.jsx(k,{id:"partPayment",label:"قيمة الدفعة",type:"number",value:x,onChange:a=>v(a.target.value)}),e.jsx(Y,{isOpen:N,setIsOpen:b,className:"",customerId:I,setCustomerId:l}),e.jsx(k,{label:"ملاحظات",value:u,onChange:a=>S(a.target.value)}),e.jsx(d,{className:"w-full md:col-span-2",type:"submit",disabled:r.isPending,children:r.isPending?"جاري إتمام البيع...":"اتمام عملية البيع"})]}),r.isError&&e.jsx("p",{className:"text-red-500 mt-2",children:r.error.message})]})}function me({setIsOpen:y,selectedItems:i}){const n=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"needQty",label:"الكمية المستخدمة",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"cost",label:"السعر النهائي",sortable:!0}];return e.jsx("div",{children:e.jsx(V,{titleButton:e.jsx(d,{variant:"outline",className:"w-1/4 mr-auto",onClick:()=>y(!1),children:"رجوع"}),searchable:!1,defaultPageSize:3,title:"المجموع",pageSizeOptions:[3],data:i?i.map(h=>({...h,cost:h.costPerUnit*h.needQty})):[],columns:n})})}function pe({products:y=[],selectedRows:i,setSelectedRows:n}){const[h,c]=s.useState("table"),[g,x]=s.useState(null),[v,N]=s.useState(1),[b,I]=s.useState(10),[l,u]=s.useState(!1),S=A();s.useEffect(()=>{const t=JSON.parse(localStorage.getItem("InventoryUser")||"null");x(t)},[]);const f=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"unit",label:"الواحدة",sortable:!0},{key:"needQty",label:"الكمية المستخدمة",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"category",label:"الصنف",sortable:!0}],Q=B({mutationFn:t=>re(t),onSuccess:()=>{P.success("تم انقاص الكميات من المخزون بنجاح."),n([]),S.invalidateQueries({queryKey:["products-table"]})},onError:t=>{console.error(t),P.error("حدث خطأ أثناء انقاص الكميات من المخزون.")}}),D=(t,r)=>{n(p=>p.map(a=>a.id===t?{...a,needQty:r}:a))},C=t=>{n(r=>r.some(a=>a.id===t.id)?r.filter(a=>a.id!==t.id):[...r,t])},U=(t,r)=>{const p=t[r];return r==="needQty"?e.jsx("input",{type:"number",value:p||"",onChange:a=>D(t.id,Number(a.target.value)),className:"w-full border rounded px-1 text-right"}):p},m=s.useMemo(()=>{const t=(v-1)*b;return i.slice(t,t+b)},[i,v,b]);return h==="sell"?g?e.jsx(be,{createdBy:g.username,selectedItems:i,isOpen:!0,setIsOpen:()=>c("table")}):e.jsx("p",{children:"Loading user..."}):h==="create"?e.jsx(me,{setIsOpen:()=>c("table"),selectedItems:i}):e.jsxs(_,{children:[e.jsxs(w,{children:[e.jsx(R,{children:"انشاء منتج / بيع مواد"}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx(d,{variant:"accent",className:"w-full",onClick:()=>c("sell"),children:"بيع المواد"}),e.jsxs(L,{isOpen:l,setIsOpen:u,title:"",trigger:e.jsx(d,{onClick:t=>{t.stopPropagation(),i.map(r=>{if(!r.needQty||r.needQty<=0)throw P.error(`الرجاء تحديد كمية صحيحة للمنتج: ${r.name}`),new Error("Invalid quantity");u(!0)})},className:"w-full",children:"انقاص من المخزون"}),children:[e.jsxs("div",{children:[i.map(t=>e.jsx("div",{className:"flex justify-between mb-2",children:e.jsxs("span",{children:[t.needQty," ",t.unit," من ",t.name]})},t.id)),"هل انت متأكد من انك تريد انقاص الكميات المحددة من المخزون؟"]}),e.jsx(d,{onClick:()=>{let t=[];i.map(r=>t.push({id:r.id,quantity:r.needQty})),Q.mutate(t),u(!1)},children:"تأكيد وانقاص من المخزون"})]})]})]}),e.jsxs(ee,{children:[e.jsxs(te,{children:[e.jsx(ae,{children:e.jsx(z,{children:f.map(t=>e.jsx(se,{className:t.hidden?"hidden":"text-center",children:t.label},t.key))})}),e.jsx(ne,{children:m.length>0?m.map((t,r)=>e.jsx(z,{onDoubleClick:()=>C(t),className:"cursor-pointer hover:bg-muted/50",children:f.map(p=>e.jsx(K,{className:p.hidden?"hidden":"",children:U(t,p.key)},p.key))},r)):e.jsx(z,{children:e.jsx(K,{colSpan:f.length,className:"text-center",children:"لا توجد بيانات"})})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("span",{children:["الصفحة ",v," من"," ",Math.ceil(i.length/b)||1]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{size:"sm",variant:"outline",onClick:()=>N(t=>Math.max(t-1,1)),disabled:v===1,children:"السابق"}),e.jsx(d,{size:"sm",variant:"outline",onClick:()=>N(t=>Math.min(t+1,Math.ceil(i.length/b))),disabled:v>=Math.ceil(i.length/b),children:"التالي"})]})]})]})]})}function ge(){le();const[y,i]=s.useState(!1),[n,h]=s.useState([]),[c,g]=s.useState(null),{data:x,isLoading:v}=ie({queryKey:["items-table"],queryFn:ue}),N=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"quantity",label:"الكمية",sortable:!0},{key:"unit",label:"الواحدة",sortable:!0},{key:"sellPerUnit",label:"سعر الواحدة",sortable:!0},{key:"lastUpdated",label:"اخر تعديل",sortable:!0},{key:"category",label:"الصنف",sortable:!0}],b=l=>n.some(u=>u.id===l.id),I=l=>{h(u=>b(l)?u.filter(f=>f.id!==l.id):[...u,l])};return s.useEffect(()=>{y||g(null)},[y]),e.jsxs(oe,{children:[e.jsx("div",{children:e.jsx(V,{title:"قائمة المنتجات",titleButton:e.jsx(de,{isOpen:y,setIsOpen:i,row:c}),columns:N,data:x||[],onRowClick:l=>I(l),getRowClassName:l=>n!=null&&n.some(u=>u==l)?"bg-green-50 hover:bg-green-100":"",renderRowActions:l=>e.jsx("div",{className:"flex gap-1",children:e.jsx(d,{onClick:u=>{u.stopPropagation(),i(!0),g(l)},children:"شراء المزيد"})})})}),(n==null?void 0:n.length)>0?e.jsx("div",{children:e.jsx(pe,{selectedRows:n,setSelectedRows:h,products:n})}):e.jsx("div",{})]})}export{ge as default};
