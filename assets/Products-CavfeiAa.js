import{r as l,u as K,a as q,b as O,j as t,D as Q,P as z,F as o,I as R,B as j,X,c as _,d as $,g as G,e as H}from"./index-Cr_78kqx.js";function W(){const[w,m]=l.useState(!1),[b,v]=l.useState(""),[y,f]=l.useState(""),[N,C]=l.useState(""),[g,I]=l.useState(""),[x,P]=l.useState(!0),[c,S]=l.useState(""),[u,d]=l.useState([]),F=K(),{data:U}=q({queryKey:["products-table"],queryFn:G}),{data:a,isLoading:J}=q({queryKey:["items-table"],queryFn:H}),D=O({mutationFn:e=>$(e),onSuccess:()=>{F.invalidateQueries({queryKey:["products-table"]}),v(""),f(""),C(""),I(""),d([]),P(!0),m(!1)},onError:()=>{alert("حدث خطأ أثناء إضافة المنتج")}}),L=(e,r,n)=>{d(s=>{const p=[...s];return p[e][r]=n,p})},M=({itemId:e,itemName:r,quantity:n})=>{d(s=>s.find(i=>i.itemId===e)?s.map(i=>i.itemId===e?{...i,quantity:Number(i.quantity)+Number(n)}:i):[...s,{itemId:e,itemName:r,quantity:Number(n)||0}]),S("")},k=l.useMemo(()=>a==null?void 0:a.filter(e=>e.name.toLowerCase().includes(c.toLowerCase())),[a,c]),h=l.useMemo(()=>u.reduce((e,r)=>{const n=a==null?void 0:a.find(s=>s.id===r.itemId);return n?e+r.quantity*n.costPerUnit:e},0),[u,a]),T=l.useMemo(()=>u.reduce((e,r)=>{const n=a==null?void 0:a.find(s=>s.id===r.itemId);return n?e+r.quantity*n.sellPerUnit:e},0),[u,a]),A=e=>{d(r=>r.filter((n,s)=>s!==e))},B=()=>{if(!b||!y||!h||!g){alert("يجب تعبئة جميع الحقول الأساسية");return}if(u.length<=0){alert("الرجاء اختيار مكون واحد على الاقل");return}const e={id:crypto.randomUUID(),name:b,category:y,cost:Number(h),price:Number(g),prepTime:Number(N)||0,timesSold:0,ingredients:u,available:x,createdAt:new Date().toISOString()};D.mutate(e)},E=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"category",label:"الصنف",sortable:!0},{key:"prepTime",label:"وقت التحضير",sortable:!0},{key:"cost",label:"التكلفة",sortable:!0},{key:"price",label:"سعر المبيع",sortable:!0},{key:"timesSold",label:"مرات البيع",sortable:!0}];return t.jsxs(Q,{children:[t.jsxs(z,{title:"إنشاء منتج",isOpen:w,setIsOpen:m,trigger:null,children:[t.jsxs("div",{className:"grid grid-cols-2 gap-2 p-2",children:[t.jsx(o,{label:"اسم المنتج",value:b,onChange:e=>v(e.target.value)}),t.jsx(o,{label:"الصنف",value:y,onChange:e=>f(e.target.value)}),t.jsx(o,{label:"وقت التحضير (دقائق)",type:"number",value:N,onChange:e=>C(Number(e.target.value))}),t.jsx(o,{label:"التكلفة",type:"number",value:h}),t.jsx(o,{label:"سعر المبيع",placeholder:T.toString(),type:"number",value:g,onChange:e=>I(Number(e.target.value))}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("label",{children:"متاح للبيع؟"}),t.jsx("input",{type:"checkbox",checked:x,onChange:()=>P(!x)})]})]}),t.jsxs("div",{className:"border p-3 rounded-md max-h-64 overflow-y-auto mt-3",children:[t.jsx("div",{className:"font-semibold mb-2",children:"المكونات"}),t.jsx(R,{placeholder:"ابحث عن المنتج بالاسم أو الكود...",value:c,onChange:e=>S(e.target.value),className:"mb-2"}),c&&k.length>0&&t.jsx("div",{className:"max-h-40 overflow-y-auto border p-2 rounded mb-4",children:k.map(e=>t.jsx("div",{className:"flex justify-between items-center p-1 hover:bg-gray-100 cursor-pointer",onClick:()=>M({itemId:e.id,itemName:e.name,quantity:1}),children:t.jsxs("span",{children:[e.name," (",e.category,") - $",e.sellPerUnit]})},e.id))}),u.map((e,r)=>{var n;return t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 mb-3 items-end",children:[t.jsx(o,{label:"اسم المادة",value:e.itemName}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(o,{label:"الكمية",type:"number",value:e.quantity,onChange:s=>L(r,"quantity",Number(s.target.value))}),t.jsx(o,{label:"مبيع الواحدة",type:"number",value:e.itemId?(n=a==null?void 0:a.find(s=>s.id===e.itemId))==null?void 0:n.sellPerUnit:0}),u.length>1&&t.jsx(j,{variant:"destructive",className:"h-10 mt-6",size:"icon",onClick:()=>A(r),children:t.jsx(X,{})})]})]},r)})]}),t.jsx(j,{className:"mt-4 w-full",onClick:B,children:"إنشاء المنتج"})]}),t.jsx("div",{children:t.jsx(_,{title:"المنتجات",titleButton:t.jsx(j,{onClick:()=>m(!0),children:"إنشاء منتج جديد"}),data:U||[],columns:E})})]})}export{W as default};
