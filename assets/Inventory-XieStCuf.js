import{r as s,u as B,b as V,j as e,P as J,F as v,B as d,w as _,c as K,n as w,x as R,C as ee,q as te,s as ae,k as se,T as ne,y as re,z as A,E as le,G as ie,J as H,K as oe,m as ue,a as ce,D as de,e as be}from"./index-Cr_78kqx.js";import{S as me}from"./SupplierSelect-BhjgBanj.js";function pe({isOpen:p,setIsOpen:o,row:r}){const[y,c]=s.useState(!1),[h,g]=s.useState(""),[j,S]=s.useState(""),[m,k]=s.useState(""),[i,u]=s.useState("0"),[U,x]=s.useState(0),[C,Q]=s.useState(0),[P,N]=s.useState(0),[I,t]=s.useState(""),[n,b]=s.useState("cash"),[a,D]=s.useState("0"),[M,T]=s.useState(""),[q,L]=s.useState({}),$=B();s.useEffect(()=>{r&&p&&(g(r.name||""),S(r.category||""),k(r.unit||""),x(r.minQuantity||0),Q(r.costPerUnit||0),N(r.sellPerUnit||0),T(r.notes||""))},[r,p]),s.useEffect(()=>{p||(g(""),S(""),k(""),u("0"),x(0),Q(0),N(0),t(""),D("0"),T(""),b("cash"),L({}))},[p]);const F=V({mutationFn:l=>_(l),onSuccess:()=>{alert("✅ تم شراء المنتج وتسجيل العملية بنجاح!"),o(!1),$.invalidateQueries({queryKey:["items-table"]})},onError:l=>{console.error(l),alert("❌ حدث خطأ أثناء معالجة العملية")}}),G=l=>{l.preventDefault();const f={};if(h||(f.name="⚠️ الرجاء إدخال اسم المنتج"),j||(f.category="⚠️ الرجاء إدخال الصنف"),m||(f.unit="⚠️ الرجاء إدخال الوحدة"),Number(i)<=0&&(f.quantity="⚠️ الكمية يجب أن تكون أكبر من صفر"),C<=0&&(f.costPerUnit="⚠️ سعر الشراء يجب أن يكون أكبر من صفر"),P<=0&&(f.sellPerUnit="⚠️ سعر البيع يجب أن يكون أكبر من صفر"),I||(f.supplierId="⚠️ الرجاء اختيار المورد"),n==="part"){Number(a)<=0&&(f.partValue="⚠️ الدفعة الجزئية يجب أن تكون أكبر من صفر");const Z=Number(i)*C;Number(a)>=Z&&(f.partValue="⚠️ الدفعة الجزئية يجب أن تكون أقل من المجموع الكلي")}if(L(f),Object.keys(f).length>0&&alert(JSON.stringify(f)),Object.keys(f).length>0)return;const O=Number(i)*C;let E=0,z="unpaid";n==="cash"?(E=O,z="paid"):n==="part"&&(E=Number(a),z="partial");const W={name:h,category:j,unit:m,quantity:Number(i),minQuantity:U,costPerUnit:C,sellPerUnit:P,lastUpdated:new Date().toISOString()},X={type:"in",quantity:Number(i),reason:"شراء من المورد",createdAt:new Date().toISOString()},Y={type:"purchase",relatedId:I,items:[{quantity:Number(i),cost:C}],subTotal:O,discount:0,total:O,paidAmount:E,remainingAmount:O-E,status:z,paymentMethod:n==="cash"?"cash":n==="part"?"part":"debt",dueDate:new Date().toISOString(),notes:M,createdBy:"system"};F.mutate({supplierId:I,itemData:W,logData:X,invoiceData:Y})};return e.jsx(J,{title:"شراء منتج من مورد",isOpen:p,setIsOpen:o,trigger:e.jsx(d,{children:"شراء منتج"}),children:e.jsxs("form",{dir:"rtl",className:"grid grid-cols-2 gap-3",children:[e.jsx(v,{id:"productName",label:"اسم المنتج",value:h,onChange:l=>g(l.target.value),error:q.name}),e.jsx(v,{id:"productCategory",label:"الصنف",value:j,onChange:l=>S(l.target.value),error:q.category}),e.jsx(v,{id:"unit",label:"الوحدة",value:m,onChange:l=>k(l.target.value),error:q.unit}),e.jsx(v,{id:"quantity",label:"الكمية",type:"number",value:i,onChange:l=>u(l.target.value),error:q.quantity}),e.jsx(v,{id:"costPerUnit",label:"سعر الشراء للواحدة",type:"number",value:C,onChange:l=>Q(Number(l.target.value)),error:q.costPerUnit}),e.jsx(v,{id:"sellPerUnit",label:"سعر البيع للواحدة",type:"number",value:P,onChange:l=>N(Number(l.target.value)),error:q.sellPerUnit}),e.jsx(v,{id:"invMinQuantity",label:"الحد الأدنى للكمية",type:"number",value:U,onChange:l=>x(Number(l.target.value))}),e.jsx(me,{className:"col-span-2",isOpen:y,setIsOpen:c,supplierId:I,setSupplierId:t,withDataTable:!0}),e.jsxs("div",{className:"col-span-2 grid grid-cols-3 gap-2",children:[e.jsx(d,{onClick:()=>b("cash"),variant:n==="cash"?"default":"outline",type:"button",children:"نقدًا"}),e.jsx(d,{onClick:()=>b("part"),variant:n==="part"?"default":"outline",type:"button",children:"جزئي"}),e.jsx(d,{onClick:()=>b("debt"),variant:n==="debt"?"default":"outline",type:"button",children:"دين"})]}),n==="part"&&e.jsx(v,{id:"partPayment",label:"قيمة الدفعة الجزئية",type:"number",value:a,onChange:l=>D(l.target.value),error:q.partValue}),e.jsx(v,{id:"notes",label:"ملاحظات",value:M,onChange:l=>T(l.target.value)}),e.jsx(d,{className:"col-span-2 mt-3",onClick:l=>{G(l)},variant:"default",disabled:F.isPending,children:F.isPending?"جاري التحميل ...":"تأكيد العملية"})]})})}function ye({isOpen:p,setIsOpen:o,selectedItems:r,createdBy:y}){const[c,h]=s.useState("cash"),[g,j]=s.useState(""),[S,m]=s.useState(!1),[k,i]=s.useState(""),[u,U]=s.useState(""),[x,C]=s.useState(0),Q=B(),P=s.useMemo(()=>r.reduce((a,D)=>a+D.costPerUnit*D.needQty,0),[r]),N=Math.max(P-x,0),I=s.useMemo(()=>c==="cash"?N:c==="part"&&Number(g)||0,[c,g,N]),t=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"needQty",label:"الكمية المستخدمة",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"cost",label:"السعر النهائي",sortable:!0}],n=V({mutationFn:a=>R(a),onSuccess:()=>{alert("تم اتمام عملية البيع بنجاح"),Q.invalidateQueries({queryKey:["inventory-items"]}),o(!1)},onError:a=>{console.error(a),alert((a==null?void 0:a.message)||"حدث خطأ أثناء عملية البيع")}}),b=a=>{if(a.preventDefault(),r.length===0){alert("يرجى اختيار العناصر للبيع");return}if(c==="part"&&(!g||Number(g)<=0)){alert("يرجى إدخال قيمة الدفعة الجزئية الصحيحة");return}const D={customerId:k||void 0,createdBy:y,invoiceData:{items:r.map(M=>({itemId:M.id,quantity:M.needQty,cost:M.costPerUnit})),subTotal:P,discount:x,total:N,paidAmount:I,paymentMethod:c==="debt"?"debt":"cash",notes:u||""}};n.mutate(D)};return e.jsxs("div",{children:[e.jsx(K,{titleButton:e.jsx(d,{variant:"outline",className:"w-1/4 mr-auto",onClick:()=>o(!1),children:"رجوع"}),searchable:!1,defaultPageSize:3,title:`المجموع: ${P}`,pageSizeOptions:[3],data:r?r.map(a=>({...a,cost:a.costPerUnit*a.needQty})):[],columns:t}),e.jsxs("form",{className:"space-y-2",onSubmit:b,children:[e.jsx(v,{label:"حسم",type:"number",value:x,onChange:a=>C(Number(a.target.value))}),e.jsxs("label",{children:["المجموع النهائي: ",N]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 md:col-span-2",children:[e.jsx(d,{onClick:()=>h("cash"),className:"col-span-1",variant:c==="cash"?"default":"outline",type:"button",children:"نقدا"}),e.jsx(d,{onClick:()=>h("part"),className:"col-span-1",variant:c==="part"?"default":"outline",type:"button",children:"جزئي"}),e.jsx(d,{onClick:()=>h("debt"),className:"col-span-1",variant:c==="debt"?"default":"outline",type:"button",children:"دين"})]}),c==="part"&&e.jsx(v,{id:"partPayment",label:"قيمة الدفعة",type:"number",value:g,onChange:a=>j(a.target.value)}),e.jsx(w,{isOpen:S,setIsOpen:m,className:"",customerId:k,setCustomerId:i}),e.jsx(v,{label:"ملاحظات",value:u,onChange:a=>U(a.target.value)}),e.jsx(d,{className:"w-full md:col-span-2",type:"submit",disabled:n.isPending,children:n.isPending?"جاري إتمام البيع...":"اتمام عملية البيع"})]}),n.isError&&e.jsx("p",{className:"text-red-500 mt-2",children:n.error.message})]})}function he({setIsOpen:p,selectedItems:o}){const r=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"needQty",label:"الكمية المستخدمة",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"cost",label:"السعر النهائي",sortable:!0}];return e.jsx("div",{children:e.jsx(K,{titleButton:e.jsx(d,{variant:"outline",className:"w-1/4 mr-auto",onClick:()=>p(!1),children:"رجوع"}),searchable:!1,defaultPageSize:3,title:"المجموع",pageSizeOptions:[3],data:o?o.map(y=>({...y,cost:y.costPerUnit*y.needQty})):[],columns:r})})}function ge({products:p=[],selectedRows:o,setSelectedRows:r}){const[y,c]=s.useState("table"),[h,g]=s.useState(null),[j,S]=s.useState(1),[m,k]=s.useState(10),[i,u]=s.useState(!1),U=B();s.useEffect(()=>{const t=JSON.parse(localStorage.getItem("InventoryUser")||"null");g(t)},[]);const x=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"unit",label:"الواحدة",sortable:!0},{key:"needQty",label:"الكمية المستخدمة",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"category",label:"الصنف",sortable:!0}],C=V({mutationFn:t=>oe(t),onSuccess:()=>{alert("تم انقاص الكميات من المخزون بنجاح."),r([]),U.invalidateQueries({queryKey:["products-table"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء انقاص الكميات من المخزون.")}}),Q=(t,n)=>{r(b=>b.map(a=>a.id===t?{...a,needQty:n}:a))},P=t=>{r(n=>n.some(a=>a.id===t.id)?n.filter(a=>a.id!==t.id):[...n,t])},N=(t,n)=>{const b=t[n];return n==="needQty"?e.jsx("input",{type:"number",value:b||"",onChange:a=>Q(t.id,Number(a.target.value)),className:"w-full border rounded px-1 text-right"}):b},I=s.useMemo(()=>{const t=(j-1)*m;return o.slice(t,t+m)},[o,j,m]);return y==="sell"?h?e.jsx(ye,{createdBy:h.username,selectedItems:o,isOpen:!0,setIsOpen:()=>c("table")}):e.jsx("p",{children:"Loading user..."}):y==="create"?e.jsx(he,{setIsOpen:()=>c("table"),selectedItems:o}):e.jsxs(ee,{children:[e.jsxs(te,{children:[e.jsx(ae,{children:"انشاء منتج / بيع مواد"}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx(d,{variant:"accent",className:"w-full",onClick:()=>c("sell"),children:"بيع المواد"}),e.jsxs(J,{isOpen:i,setIsOpen:u,title:"",trigger:e.jsx(d,{onClick:t=>{t.stopPropagation(),o.map(n=>{if(!n.needQty||n.needQty<=0)throw alert(`الرجاء تحديد كمية صحيحة للمنتج: ${n.name}`),new Error("Invalid quantity");u(!0)})},className:"w-full",children:"انقاص من المخزون"}),children:[e.jsxs("div",{children:[o.map(t=>e.jsx("div",{className:"flex justify-between mb-2",children:e.jsxs("span",{children:[t.needQty," ",t.unit," من ",t.name]})},t.id)),"هل انت متأكد من انك تريد انقاص الكميات المحددة من المخزون؟"]}),e.jsx(d,{onClick:()=>{let t=[];o.map(n=>t.push({id:n.id,quantity:n.needQty})),C.mutate(t),u(!1)},children:"تأكيد وانقاص من المخزون"})]})]})]}),e.jsxs(se,{children:[e.jsxs(ne,{children:[e.jsx(re,{children:e.jsx(A,{children:x.map(t=>e.jsx(le,{className:t.hidden?"hidden":"text-center",children:t.label},t.key))})}),e.jsx(ie,{children:I.length>0?I.map((t,n)=>e.jsx(A,{onDoubleClick:()=>P(t),className:"cursor-pointer hover:bg-muted/50",children:x.map(b=>e.jsx(H,{className:b.hidden?"hidden":"",children:N(t,b.key)},b.key))},n)):e.jsx(A,{children:e.jsx(H,{colSpan:x.length,className:"text-center",children:"لا توجد بيانات"})})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("span",{children:["الصفحة ",j," من"," ",Math.ceil(o.length/m)||1]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{size:"sm",variant:"outline",onClick:()=>S(t=>Math.max(t-1,1)),disabled:j===1,children:"السابق"}),e.jsx(d,{size:"sm",variant:"outline",onClick:()=>S(t=>Math.min(t+1,Math.ceil(o.length/m))),disabled:j>=Math.ceil(o.length/m),children:"التالي"})]})]})]})]})}function je(){ue();const[p,o]=s.useState(!1),[r,y]=s.useState([]),[c,h]=s.useState(null),{data:g,isLoading:j}=ce({queryKey:["items-table"],queryFn:be}),S=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"quantity",label:"الكمية",sortable:!0},{key:"unit",label:"الواحدة",sortable:!0},{key:"sellPerUnit",label:"سعر الواحدة",sortable:!0},{key:"lastUpdated",label:"اخر تعديل",sortable:!0},{key:"category",label:"الصنف",sortable:!0}],m=i=>r.some(u=>u.id===i.id),k=i=>{y(u=>m(i)?u.filter(x=>x.id!==i.id):[...u,i])};return s.useEffect(()=>{p||h(null)},[p]),e.jsxs(de,{children:[e.jsx("div",{children:e.jsx(K,{title:"قائمة المنتجات",titleButton:e.jsx(pe,{isOpen:p,setIsOpen:o,row:c}),columns:S,data:g||[],onRowClick:i=>k(i),getRowClassName:i=>r!=null&&r.some(u=>u==i)?"bg-green-50 hover:bg-green-100":"",renderRowActions:i=>e.jsx("div",{className:"flex gap-1",children:e.jsx(d,{onClick:u=>{u.stopPropagation(),o(!0),h(i)},children:"شراء المزيد"})})})}),(r==null?void 0:r.length)>0?e.jsx("div",{children:e.jsx(ge,{selectedRows:r,setSelectedRows:y,products:r})}):e.jsx("div",{})]})}export{je as default};
