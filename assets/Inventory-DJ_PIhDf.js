import{r as s,u as z,b as B,j as e,P as L,F as C,B as b,O as Z,n as k,c as V,o as _,Q as G,C as X,s as w,t as R,k as ee,T as te,U as ae,V as A,W as se,Y as ne,Z as K,_ as re,m as le,a as ie,D as oe,e as ue}from"./index-DgmbDGaC.js";import{S as ce}from"./SupplierSelect-CJD4nJNI.js";function de({isOpen:S,setIsOpen:r,row:l}){const[c,d]=s.useState(!1),[j,m]=s.useState(""),[g,P]=s.useState(""),[p,I]=s.useState(""),[x,i]=s.useState(""),[o,v]=s.useState(""),[U,D]=s.useState(""),[N,Q]=s.useState(""),[y,t]=s.useState("cash"),[n,h]=s.useState(""),[a,O]=s.useState({}),q=z();s.useEffect(()=>{l&&S&&(m(l.name||""),P(l.category||""),I(l.unit||""),v(l.costPerUnit||0),D(l.sellPerUnit||0))},[l,S]),s.useEffect(()=>{S||(m(""),P(""),I(""),i("0"),v("0"),D("0"),Q(""),h("0"),t("cash"),O({}))},[S]);const T=B({mutationFn:u=>Z(u),onSuccess:()=>{k.success(" تم شراء المنتج وتسجيل العملية بنجاح!"),r(!1),q.invalidateQueries({queryKey:["items-table"]})},onError:u=>{console.error(u),k.error("حدث خطأ أثناء معالجة العملية")}}),H=u=>{u.preventDefault();const f={};if(j||(f.name="⚠️ الرجاء إدخال اسم المنتج"),g||(f.category="⚠️ الرجاء إدخال الصنف"),p||(f.unit="⚠️ الرجاء إدخال الوحدة"),Number(x)<=0&&(f.quantity="⚠️ الكمية يجب أن تكون أكبر من صفر"),Number(o)<=0&&(f.costPerUnit="⚠️ سعر الشراء يجب أن يكون أكبر من صفر"),Number(U)<=0&&(f.sellPerUnit="⚠️ سعر البيع يجب أن يكون أكبر من صفر"),N||(f.supplierId="⚠️ الرجاء اختيار المورد"),y==="part"){Number(n)<=0&&(f.partValue="⚠️ الدفعة الجزئية يجب أن تكون أكبر من صفر");const Y=Number(x)*Number(o);Number(n)>=Y&&(f.partValue="⚠️ الدفعة الجزئية يجب أن تكون أقل من المجموع الكلي")}if(O(f),Object.keys(f).length>0&&k.error(JSON.stringify(f)),Object.keys(f).length>0)return;const M=Number(x)*Number(o);let E=0,F="unpaid";y==="cash"?(E=M,F="paid"):y==="part"&&(E=Number(n),F="partial");const J={name:j,category:g,unit:p,minQuantity:0,quantity:Number(x),costPerUnit:Number(o),sellPerUnit:Number(U),lastUpdated:new Date().toISOString()},$={type:"in",quantity:Number(x),reason:"شراء من المورد",createdAt:new Date().toISOString()},W={type:"purchase",relatedId:N,items:[{quantity:Number(x),cost:Number(o)}],subTotal:M,discount:0,total:M,paidAmount:E,remainingAmount:M-E,status:F,paymentMethod:y==="cash"?"cash":y==="part"?"part":"debt",dueDate:new Date().toISOString(),createdBy:"system",notes:""};T.mutate({supplierId:N,itemData:J,logData:$,invoiceData:W})};return e.jsx(L,{title:"شراء منتج من مورد",isOpen:S,setIsOpen:r,trigger:e.jsx(b,{children:"شراء منتج"}),children:e.jsxs("form",{dir:"rtl",className:"grid grid-cols-2 gap-3",children:[e.jsx(C,{id:"productName",label:"اسم المنتج",value:j,onChange:u=>m(u.target.value),error:a.name}),e.jsx(C,{id:"productCategory",label:"الصنف",value:g,onChange:u=>P(u.target.value),error:a.category}),e.jsx(C,{id:"unit",label:"الوحدة",value:p,onChange:u=>I(u.target.value),error:a.unit}),e.jsx(C,{id:"quantity",label:"الكمية",type:"number",value:x,onChange:u=>i(u.target.value),error:a.quantity}),e.jsx(C,{id:"costPerUnit",label:"سعر الشراء للواحدة",type:"number",value:o,onChange:u=>v(u.target.value),error:a.costPerUnit}),e.jsx(C,{id:"sellPerUnit",label:"سعر البيع للواحدة",type:"number",value:U,onChange:u=>D(u.target.value),error:a.sellPerUnit}),e.jsx(ce,{className:"col-span-2",isOpen:c,setIsOpen:d,supplierId:N,setSupplierId:Q,withDataTable:!0}),e.jsxs("div",{className:"col-span-2 grid grid-cols-3 gap-2",children:[e.jsx(b,{onClick:()=>t("cash"),variant:y==="cash"?"default":"outline",type:"button",children:"نقدًا"}),e.jsx(b,{onClick:()=>t("part"),variant:y==="part"?"default":"outline",type:"button",children:"جزئي"}),e.jsx(b,{onClick:()=>t("debt"),variant:y==="debt"?"default":"outline",type:"button",children:"دين"})]}),y==="part"&&e.jsx(C,{id:"partPayment",label:"قيمة الدفعة الجزئية",type:"number",value:n,onChange:u=>h(u.target.value),error:a.partValue}),e.jsx(b,{className:"col-span-2 mt-3",onClick:u=>{H(u)},variant:"default",disabled:T.isPending,children:T.isPending?"جاري التحميل ...":"تأكيد العملية"})]})})}function be({isOpen:S,setIsOpen:r,selectedItems:l,createdBy:c}){const[d,j]=s.useState("cash"),[m,g]=s.useState(""),[P,p]=s.useState(!1),[I,x]=s.useState(""),[i,o]=s.useState(""),[v,U]=s.useState(0),D=z(),N=s.useMemo(()=>l.reduce((a,O)=>a+O.costPerUnit*O.needQty,0),[l]),Q=Math.max(N-v,0),y=s.useMemo(()=>d==="cash"?Q:d==="part"&&Number(m)||0,[d,m,Q]),t=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"needQty",label:"الكمية المستخدمة",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"cost",label:"السعر النهائي",sortable:!0}],n=B({mutationFn:a=>G(a),onSuccess:()=>{k.success("تم اتمام عملية البيع بنجاح"),D.invalidateQueries({queryKey:["inventory-items"]}),r(!1)},onError:a=>{console.error(a),k.error((a==null?void 0:a.message)||"حدث خطأ أثناء عملية البيع")}}),h=a=>{if(a.preventDefault(),l.length===0){k.error("يرجى اختيار العناصر للبيع");return}if(d==="part"&&(!m||Number(m)<=0)){k.error("يرجى إدخال قيمة الدفعة الجزئية الصحيحة");return}const O={customerId:I||void 0,createdBy:c,invoiceData:{items:l.map(q=>({itemId:q.id,quantity:q.needQty,cost:q.costPerUnit})),subTotal:N,discount:v,total:Q,paidAmount:y,paymentMethod:d==="debt"?"debt":"cash",notes:i||""}};n.mutate(O)};return e.jsxs("div",{children:[e.jsx(V,{titleButton:e.jsx(b,{variant:"outline",className:"w-1/4 mr-auto",onClick:()=>r(!1),children:"رجوع"}),searchable:!1,defaultPageSize:3,title:`المجموع: ${N}`,pageSizeOptions:[3],data:l?l.map(a=>({...a,cost:a.costPerUnit*a.needQty})):[],columns:t}),e.jsxs("form",{className:"space-y-2",onSubmit:h,children:[e.jsx(C,{label:"حسم",type:"number",value:v,onChange:a=>U(Number(a.target.value))}),e.jsxs("label",{children:["المجموع النهائي: ",Q]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 md:col-span-2",children:[e.jsx(b,{onClick:()=>j("cash"),className:"col-span-1",variant:d==="cash"?"default":"outline",type:"button",children:"نقدا"}),e.jsx(b,{onClick:()=>j("part"),className:"col-span-1",variant:d==="part"?"default":"outline",type:"button",children:"جزئي"}),e.jsx(b,{onClick:()=>j("debt"),className:"col-span-1",variant:d==="debt"?"default":"outline",type:"button",children:"دين"})]}),d==="part"&&e.jsx(C,{id:"partPayment",label:"قيمة الدفعة",type:"number",value:m,onChange:a=>g(a.target.value)}),e.jsx(_,{isOpen:P,setIsOpen:p,className:"",customerId:I,setCustomerId:x}),e.jsx(C,{label:"ملاحظات",value:i,onChange:a=>o(a.target.value)}),e.jsx(b,{className:"w-full md:col-span-2",type:"submit",disabled:n.isPending,children:n.isPending?"جاري إتمام البيع...":"اتمام عملية البيع"})]}),n.isError&&e.jsx("p",{className:"text-red-500 mt-2",children:n.error.message})]})}function me({setIsOpen:S,selectedItems:r}){const l=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"needQty",label:"الكمية المستخدمة",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"cost",label:"السعر النهائي",sortable:!0}];return e.jsx("div",{children:e.jsx(V,{titleButton:e.jsx(b,{variant:"outline",className:"w-1/4 mr-auto",onClick:()=>S(!1),children:"رجوع"}),searchable:!1,defaultPageSize:3,title:"المجموع",pageSizeOptions:[3],data:r?r.map(c=>({...c,cost:c.costPerUnit*c.needQty})):[],columns:l})})}function pe({products:S=[],selectedRows:r,setSelectedRows:l}){const[c,d]=s.useState("table"),[j,m]=s.useState(null),[g,P]=s.useState(1),[p,I]=s.useState(10),[x,i]=s.useState(!1),o=z();s.useEffect(()=>{const t=JSON.parse(localStorage.getItem("InventoryUser")||"null");m(t)},[]);const v=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"unit",label:"الواحدة",sortable:!0},{key:"needQty",label:"الكمية المستخدمة",sortable:!0},{key:"costPerUnit",label:"سعر الواحدة",sortable:!0},{key:"category",label:"الصنف",sortable:!0}],U=B({mutationFn:t=>re(t),onSuccess:()=>{k.success("تم انقاص الكميات من المخزون بنجاح."),l([]),o.invalidateQueries({queryKey:["products-table"]})},onError:t=>{console.error(t),k.error("حدث خطأ أثناء انقاص الكميات من المخزون.")}}),D=(t,n)=>{l(h=>h.map(a=>a.id===t?{...a,needQty:n}:a))},N=t=>{l(n=>n.some(a=>a.id===t.id)?n.filter(a=>a.id!==t.id):[...n,t])},Q=(t,n)=>{const h=t[n];return n==="needQty"?e.jsx("input",{type:"number",value:h||"",onChange:a=>D(t.id,Number(a.target.value)),className:"w-full border rounded px-1 text-right"}):h},y=s.useMemo(()=>{const t=(g-1)*p;return r.slice(t,t+p)},[r,g,p]);return c==="sell"?j?e.jsx(be,{createdBy:j.username,selectedItems:r,isOpen:!0,setIsOpen:()=>d("table")}):e.jsx("p",{children:"Loading user..."}):c==="create"?e.jsx(me,{setIsOpen:()=>d("table"),selectedItems:r}):e.jsxs(X,{children:[e.jsxs(w,{children:[e.jsx(R,{children:"انشاء منتج / بيع مواد"}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx(b,{variant:"accent",className:"w-full",onClick:()=>d("sell"),children:"بيع المواد"}),e.jsxs(L,{isOpen:x,setIsOpen:i,title:"",trigger:e.jsx(b,{onClick:t=>{t.stopPropagation(),r.map(n=>{if(!n.needQty||n.needQty<=0)throw k.error(`الرجاء تحديد كمية صحيحة للمنتج: ${n.name}`),new Error("Invalid quantity");i(!0)})},className:"w-full",children:"انقاص من المخزون"}),children:[e.jsxs("div",{children:[r.map(t=>e.jsx("div",{className:"flex justify-between mb-2",children:e.jsxs("span",{children:[t.needQty," ",t.unit," من ",t.name]})},t.id)),"هل انت متأكد من انك تريد انقاص الكميات المحددة من المخزون؟"]}),e.jsx(b,{onClick:()=>{let t=[];r.map(n=>t.push({id:n.id,quantity:n.needQty})),U.mutate(t),i(!1)},children:"تأكيد وانقاص من المخزون"})]})]})]}),e.jsxs(ee,{children:[e.jsxs(te,{children:[e.jsx(ae,{children:e.jsx(A,{children:v.map(t=>e.jsx(se,{className:t.hidden?"hidden":"text-center",children:t.label},t.key))})}),e.jsx(ne,{children:y.length>0?y.map((t,n)=>e.jsx(A,{onDoubleClick:()=>N(t),className:"cursor-pointer hover:bg-muted/50",children:v.map(h=>e.jsx(K,{className:h.hidden?"hidden":"",children:Q(t,h.key)},h.key))},n)):e.jsx(A,{children:e.jsx(K,{colSpan:v.length,className:"text-center",children:"لا توجد بيانات"})})})]}),e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("span",{children:["الصفحة ",g," من"," ",Math.ceil(r.length/p)||1]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{size:"sm",variant:"outline",onClick:()=>P(t=>Math.max(t-1,1)),disabled:g===1,children:"السابق"}),e.jsx(b,{size:"sm",variant:"outline",onClick:()=>P(t=>Math.min(t+1,Math.ceil(r.length/p))),disabled:g>=Math.ceil(r.length/p),children:"التالي"})]})]})]})]})}function ge(){const S=le(),[r,l]=s.useState(!1),[c,d]=s.useState([]),[j,m]=s.useState(null),{data:g,isLoading:P}=ie({queryKey:["items-table"],queryFn:ue}),p=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"quantity",label:"الكمية",sortable:!0},{key:"unit",label:"الواحدة",sortable:!0},{key:"sellPerUnit",label:"سعر الواحدة",sortable:!0},{key:"lastUpdated",label:"اخر تعديل",sortable:!0},{key:"category",label:"الصنف",sortable:!0}],I=i=>c.some(o=>o.id===i.id),x=i=>{d(o=>I(i)?o.filter(U=>U.id!==i.id):[...o,i])};return s.useEffect(()=>{r||m(null)},[r]),e.jsxs(oe,{children:[e.jsx("div",{children:e.jsx(V,{title:"قائمة المنتجات",titleButton:e.jsx(de,{isOpen:r,setIsOpen:l,row:j}),columns:p,data:g||[],onRowClick:i=>x(i),getRowClassName:i=>c!=null&&c.some(o=>o==i)?"bg-green-50 hover:bg-green-100":"",renderRowActions:i=>e.jsxs("div",{className:"flex gap-1",children:[e.jsx(b,{variant:"outline",onClick:o=>{o.stopPropagation(),console.log(i),S("/productDetails",{state:{...i}})},children:"التفاصيل"}),e.jsx(b,{onClick:o=>{o.stopPropagation(),l(!0),m(i)},children:"شراء المزيد"})]})})}),(c==null?void 0:c.length)>0?e.jsx("div",{children:e.jsx(pe,{selectedRows:c,setSelectedRows:d,products:c})}):e.jsx("div",{})]})}export{ge as default};
