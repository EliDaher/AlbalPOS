import{r as l,u as E,a as S,b as K,j as t,D as O,P as Q,F as u,I as T,B as j,X as z,c as R,d as X,g as _,e as $}from"./index-Bo_gVS4x.js";function J(){const[k,m]=l.useState(!1),[b,v]=l.useState(""),[y,f]=l.useState(""),[x,N]=l.useState(""),[g,I]=l.useState(!0),[c,C]=l.useState(""),[o,d]=l.useState([]),q=E(),{data:w}=S({queryKey:["products-table"],queryFn:_}),{data:a,isLoading:G}=S({queryKey:["items-table"],queryFn:$}),F=K({mutationFn:e=>X(e),onSuccess:()=>{q.invalidateQueries({queryKey:["products-table"]}),v(""),f(""),N(""),d([]),I(!0),m(!1)},onError:()=>{alert("حدث خطأ أثناء إضافة المنتج")}}),U=(e,r,n)=>{d(s=>{const p=[...s];return p[e][r]=n,p})},D=({itemId:e,itemName:r,quantity:n})=>{d(s=>s.find(i=>i.itemId===e)?s.map(i=>i.itemId===e?{...i,quantity:Number(i.quantity)+Number(n)}:i):[...s,{itemId:e,itemName:r,quantity:Number(n)||0}]),C("")},P=l.useMemo(()=>a==null?void 0:a.filter(e=>e.name.toLowerCase().includes(c.toLowerCase())),[a,c]),h=l.useMemo(()=>o.reduce((e,r)=>{const n=a==null?void 0:a.find(s=>s.id===r.itemId);return n?e+r.quantity*n.costPerUnit:e},0),[o,a]),L=l.useMemo(()=>o.reduce((e,r)=>{const n=a==null?void 0:a.find(s=>s.id===r.itemId);return n?e+r.quantity*n.sellPerUnit:e},0),[o,a]),M=e=>{d(r=>r.filter((n,s)=>s!==e))},A=()=>{if(!b||!y||!h||!x){alert("يجب تعبئة جميع الحقول الأساسية");return}if(o.length<=0){alert("الرجاء اختيار مكون واحد على الاقل");return}const e={id:crypto.randomUUID(),name:b,category:y,cost:Number(h),price:Number(x),prepTime:1,timesSold:0,ingredients:o,available:g,createdAt:new Date().toISOString()};F.mutate(e)},B=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"category",label:"الصنف",sortable:!0},{key:"prepTime",label:"وقت التحضير",sortable:!0},{key:"cost",label:"التكلفة",sortable:!0},{key:"price",label:"سعر المبيع",sortable:!0},{key:"timesSold",label:"مرات البيع",sortable:!0}];return t.jsxs(O,{children:[t.jsxs(Q,{title:"إنشاء منتج",isOpen:k,setIsOpen:m,trigger:null,children:[t.jsxs("div",{className:"grid grid-cols-2 gap-2 p-2",children:[t.jsx(u,{label:"اسم المنتج",value:b,onChange:e=>v(e.target.value)}),t.jsx(u,{label:"الصنف",value:y,onChange:e=>f(e.target.value)}),t.jsx(u,{label:"التكلفة (تحسب تلقائيا)",type:"number",value:h}),t.jsx(u,{label:"سعر المبيع",placeholder:L.toString(),type:"number",value:x,onChange:e=>N(Number(e.target.value))}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("label",{children:"متاح للبيع؟"}),t.jsx("input",{type:"checkbox",checked:g,onChange:()=>I(!g)})]})]}),t.jsxs("div",{className:"border p-3 rounded-md max-h-64 overflow-y-auto mt-3",children:[t.jsx("div",{className:"font-semibold mb-2",children:"المكونات"}),t.jsx(T,{placeholder:"ابحث عن المنتج بالاسم أو الكود...",value:c,onChange:e=>C(e.target.value),className:"mb-2"}),c&&P.length>0&&t.jsx("div",{className:"max-h-40 overflow-y-auto border p-2 rounded mb-4",children:P.map(e=>t.jsx("div",{className:"flex justify-between items-center p-1 hover:bg-gray-100 cursor-pointer",onClick:()=>D({itemId:e.id,itemName:e.name,quantity:1}),children:t.jsxs("span",{children:[e.name," (",e.category,") - $",e.sellPerUnit]})},e.id))}),o.map((e,r)=>{var n;return t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 mb-3 items-end",children:[t.jsx(u,{label:"اسم المادة",value:e.itemName}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(u,{label:"الكمية",type:"number",value:e.quantity,onChange:s=>U(r,"quantity",Number(s.target.value))}),t.jsx(u,{label:"مبيع الواحدة",type:"number",value:e.itemId?(n=a==null?void 0:a.find(s=>s.id===e.itemId))==null?void 0:n.sellPerUnit:0}),o.length>1&&t.jsx(j,{variant:"destructive",className:"h-10 mt-6",size:"icon",onClick:()=>M(r),children:t.jsx(z,{})})]})]},r)})]}),t.jsx(j,{className:"mt-4 w-full",onClick:A,children:"إنشاء المنتج"})]}),t.jsx("div",{children:t.jsx(R,{title:"المنتجات",titleButton:t.jsx(j,{onClick:()=>m(!0),children:"إنشاء منتج جديد"}),data:w||[],columns:B})})]})}export{J as default};
